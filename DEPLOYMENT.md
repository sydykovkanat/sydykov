# Deployment Guide

–≠—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –¥–µ–ø–ª–æ—è –Ω–∞ VPS —á–µ—Ä–µ–∑ GitHub Actions.

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

- **GitHub Actions**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –¥–µ–ø–ª–æ–π –ø—Ä–∏ push –≤ `main`
- **VPS**: Redis, PostgreSQL, –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ PM2
- **SSH Deploy**: –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ SSH –∫–ª—é—á–∏
- **Environment**: –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è —á–µ—Ä–µ–∑ GitHub Secrets

---

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ VPS

–ù–∞ —Ç–≤–æ–µ–º VPS –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã:

```bash
# Node.js 18+
node -v

# Yarn
yarn -v

# PM2
pm2 -v

# Git
git -v

# PostgreSQL (—É–∂–µ –µ—Å—Ç—å)
# Redis (—É–∂–µ –µ—Å—Ç—å)
```

–ö–ª–æ–Ω–∏—Ä—É–π –ø—Ä–æ–µ–∫—Ç –Ω–∞ VPS:

```bash
cd ~
git clone <repository-url> sydykov
cd sydykov
yarn install
```

–°–æ–∑–¥–∞–π `.env` —Ñ–∞–π–ª –Ω–∞ VPS:

```bash
nano ~/sydykov/.env
```

–í—Å—Ç–∞–≤—å —Å–≤–æ–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (—Å–º. `.env.example`).

–°–¥–µ–ª–∞–π –ø–µ—Ä–≤—ã–π –±–∏–ª–¥ –∏ –∑–∞–ø—É—Å–∫:

```bash
yarn build
npx prisma migrate deploy
npx prisma generate
pm2 start dist/main.js --name sydykov-bot
pm2 save
pm2 startup
```

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ GitHub Secrets

–ü–µ—Ä–µ–π–¥–∏ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –Ω–∞ GitHub: **Settings ‚Üí Secrets and variables ‚Üí Actions ‚Üí New repository secret**

–î–æ–±–∞–≤—å —Å–ª–µ–¥—É—é—â–∏–µ —Å–µ–∫—Ä–µ—Ç—ã:

#### –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ:

1. **VPS_HOST**
   - –ó–Ω–∞—á–µ–Ω–∏–µ: IP –∞–¥—Ä–µ—Å –∏–ª–∏ –¥–æ–º–µ–Ω —Ç–≤–æ–µ–≥–æ VPS
   - –ü—Ä–∏–º–µ—Ä: `123.45.67.89` –∏–ª–∏ `vps.example.com`

2. **VPS_USERNAME**
   - –ó–Ω–∞—á–µ–Ω–∏–µ: –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è SSH
   - –ü—Ä–∏–º–µ—Ä: `root` –∏–ª–∏ `ubuntu`

3. **VPS_SSH_KEY**
   - –ó–Ω–∞—á–µ–Ω–∏–µ: –ø—Ä–∏–≤–∞—Ç–Ω—ã–π SSH –∫–ª—é—á –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ VPS
   - –ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å:
     ```bash
     # –ù–∞ –ª–æ–∫–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω–µ
     cat ~/.ssh/id_rsa
     ```
   - –°–∫–æ–ø–∏—Ä—É–π –≤–µ—Å—å –∫–ª—é—á –≤–∫–ª—é—á–∞—è `-----BEGIN OPENSSH PRIVATE KEY-----` –∏ `-----END OPENSSH PRIVATE KEY-----`

#### –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ:

4. **VPS_PORT** (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π SSH –ø–æ—Ä—Ç)
   - –ó–Ω–∞—á–µ–Ω–∏–µ: –ø–æ—Ä—Ç SSH
   - –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: `22`

### 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSH –∫–ª—é—á–µ–π (–µ—Å–ª–∏ –µ—â–µ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ)

–ù–∞ –ª–æ–∫–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω–µ:

```bash
# –°–≥–µ–Ω–µ—Ä–∏—Ä—É–π SSH –∫–ª—é—á –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
ssh-keygen -t rsa -b 4096 -C "your_email@example.com"

# –°–∫–æ–ø–∏—Ä—É–π –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á –Ω–∞ VPS
ssh-copy-id username@vps-host

# –ü—Ä–æ–≤–µ—Ä—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
ssh username@vps-host
```

---

## üîÑ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –¥–µ–ø–ª–æ–π

–ü—Ä–æ—Å—Ç–æ –¥–µ–ª–∞–π push –≤ `main`:

```bash
git add .
git commit -m "your changes"
git push origin main
```

GitHub Actions –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:

1. –ü–æ–¥–∫–ª—é—á–∏—Ç—Å—è –∫ VPS
2. –°–¥–µ–ª–∞–µ—Ç `git pull`
3. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
4. –ó–∞–ø—É—Å—Ç–∏—Ç –º–∏–≥—Ä–∞—Ü–∏–∏
5. –°–æ–±–µ—Ä–µ—Ç –ø—Ä–æ–µ–∫—Ç
6. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç PM2

### –†—É—á–Ω–æ–π –¥–µ–ø–ª–æ–π

–ù–∞ VPS –º–æ–∂–µ—à—å –∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫—Ä–∏–ø—Ç –¥–µ–ø–ª–æ—è:

```bash
cd ~/sydykov
./scripts/deploy.sh
```

–ò–ª–∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å GitHub Action –≤—Ä—É—á–Ω—É—é:

- –ü–µ—Ä–µ–π–¥–∏ –Ω–∞ –≤–∫–ª–∞–¥–∫—É **Actions** –≤ GitHub
- –í—ã–±–µ—Ä–∏ **Deploy to VPS**
- –ù–∞–∂–º–∏ **Run workflow**

---

## üìù –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ENV –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏

### –°–ø–æ—Å–æ–± 1: –ù–∞–ø—Ä—è–º—É—é –Ω–∞ VPS

```bash
ssh username@vps-host
cd ~/sydykov
nano .env
# –í–Ω–µ—Å–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è
./scripts/deploy.sh  # –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç —Å –Ω–æ–≤—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
```

### –°–ø–æ—Å–æ–± 2: –ß–µ—Ä–µ–∑ GitHub Secrets (–¥–ª—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö)

–ï—Å–ª–∏ —Ö–æ—á–µ—à—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è—Ç—å `.env` –ø—Ä–∏ –¥–µ–ø–ª–æ–µ:

1. –î–æ–±–∞–≤—å –≤ GitHub Secrets –Ω–æ–≤—ã–π —Å–µ–∫—Ä–µ—Ç **ENV_FILE** —Å–æ –≤—Å–µ–º —Å–æ–¥–µ—Ä–∂–∏–º—ã–º `.env`

2. –û–±–Ω–æ–≤–∏ [.github/workflows/deploy.yml](.github/workflows/deploy.yml), –¥–æ–±–∞–≤–∏–≤ –ø–µ—Ä–µ–¥ `git pull`:
   ```yaml
   echo "${{ secrets.ENV_FILE }}" > ~/sydykov/.env
   ```

**–í–Ω–∏–º–∞–Ω–∏–µ**: –≠—Ç–æ—Ç —Å–ø–æ—Å–æ–± –ø–µ—Ä–µ–∑–∞–ø–∏—à–µ—Ç –≤–µ—Å—å `.env` —Ñ–∞–π–ª –Ω–∞ VPS.

---

## üõ†Ô∏è –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

### –ù–∞ VPS

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
pm2 status sydykov-bot

# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏
pm2 logs sydykov-bot

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å
pm2 restart sydykov-bot

# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
pm2 stop sydykov-bot

# –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
pm2 monit
```

### –õ–æ–∫–∞–ª—å–Ω–æ

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å workflow
cat .github/workflows/deploy.yml

# –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ VPS
ssh username@vps-host
```

---

## üêõ Troubleshooting

### –î–µ–ø–ª–æ–π –Ω–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç

1. –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ workflow –≤–∫–ª—é—á–µ–Ω –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
2. –ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏ –≤ Actions –Ω–∞ GitHub
3. –£–±–µ–¥–∏—Å—å, —á—Ç–æ –≤—Å–µ —Å–µ–∫—Ä–µ—Ç—ã –¥–æ–±–∞–≤–ª–µ–Ω—ã

### –û—à–∏–±–∫–∞ SSH

```
Permission denied (publickey)
```

**–†–µ—à–µ–Ω–∏–µ:**

- –£–±–µ–¥–∏—Å—å, —á—Ç–æ –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á –¥–æ–±–∞–≤–ª–µ–Ω –≤ `~/.ssh/authorized_keys` –Ω–∞ VPS
- –ü—Ä–æ–≤–µ—Ä—å –ø—Ä–∞–≤–∞: `chmod 600 ~/.ssh/authorized_keys`

### PM2 –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

```bash
# –ù–∞ VPS
cd ~/sydykov
pm2 delete sydykov-bot
pm2 start dist/main.js --name sydykov-bot
pm2 save
```

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –æ–±–Ω–æ–≤–∏–ª–∞—Å—å

```bash
# –ù–∞ VPS
cd ~/sydykov
npx prisma migrate deploy
npx prisma generate
pm2 restart sydykov-bot
```

---

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–µ–ø–ª–æ—è

```
GitHub Push ‚Üí GitHub Actions ‚Üí SSH to VPS ‚Üí Deploy Script ‚Üí PM2 Restart
```

### –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏ –¥–µ–ø–ª–æ–µ

1. **Git Pull**: –°–∫–∞—á–∏–≤–∞—é—Ç—Å—è –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
2. **Dependencies**: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (`yarn install`)
3. **Migrations**: –ü—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î (`prisma migrate deploy`)
4. **Build**: –ö–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç—Å—è TypeScript ‚Üí JavaScript
5. **Restart**: PM2 –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

### –í—Ä–µ–º—è –¥–µ–ø–ª–æ—è

–û–±—ã—á–Ω–æ **2-3 –º–∏–Ω—É—Ç—ã**:

- GitHub Actions: ~30 —Å–µ–∫
- SSH + Git Pull: ~10 —Å–µ–∫
- Dependencies: ~1 –º–∏–Ω (–µ—Å–ª–∏ –µ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è)
- Build: ~30 —Å–µ–∫
- Restart: ~5 —Å–µ–∫

---

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

**–í–∞–∂–Ω–æ:**

- ‚úÖ –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –∫–æ–º–º–∏—Ç—å `.env` –≤ Git
- ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å SSH –∫–ª—é—á–∏ –≤–º–µ—Å—Ç–æ –ø–∞—Ä–æ–ª–µ–π
- ‚úÖ –•—Ä–∞–Ω–∏—Ç—å —Å–µ–∫—Ä–µ—Ç—ã –≤ GitHub Secrets
- ‚úÖ –û–≥—Ä–∞–Ω–∏—á–∏—Ç—å SSH –¥–æ—Å—Ç—É–ø (–Ω–∞–ø—Ä–∏–º–µ—Ä, —á–µ—Ä–µ–∑ fail2ban)
- ‚úÖ –†–µ–≥—É–ª—è—Ä–Ω–æ –æ–±–Ω–æ–≤–ª—è—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

**–°–µ–∫—Ä–µ—Ç—ã:**

–í—Å–µ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ GitHub Secrets:

- API –∫–ª—é—á–∏ (OpenAI, Telegram)
- –°—Ç—Ä–æ–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î
- SSH –∫–ª—é—á–∏
- –ü–∞—Ä–æ–ª–∏

---

## üéØ Next Steps

–ü–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ CI/CD –º–æ–∂–µ—à—å –¥–æ–±–∞–≤–∏—Ç—å:

1. **Tests –≤ CI**: –ó–∞–ø—É—Å–∫–∞—Ç—å —Ç–µ—Å—Ç—ã –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º
2. **Staging Environment**: –¢–µ—Å—Ç–æ–≤—ã–π —Å–µ—Ä–≤–µ—Ä –ø–µ—Ä–µ–¥ –ø—Ä–æ–¥–æ–º
3. **Rollback**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –æ—Ç–∫–∞—Ç –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
4. **Monitoring**: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram –ø—Ä–∏ –¥–µ–ø–ª–æ–µ
5. **Backups**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –±—ç–∫–∞–ø—ã –ë–î

–ü—Ä–∏–º–µ—Ä—ã –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤ [.github/workflows/deploy.yml](.github/workflows/deploy.yml).
